
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Spook Ice - Vers√£o Corrigida</title>
    <style>
        body { font-family: sans-serif; background: #f4f4f9; padding: 20px; text-align: center; }
        .nav-buttons { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .btn { text-decoration: none; background: #007bff; color: white; padding: 10px; border-radius: 5px; font-weight: bold; border: none; cursor: pointer; }
        .card { background: white; border-radius: 10px; padding: 20px; margin: 10px auto; max-width: 400px; border-left: 5px solid #25d366; text-align: left; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-imprimir { background: #333; color: white; width: 100%; padding: 10px; margin-top: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #status { font-weight: bold; margin-bottom: 10px; color: blue; }
        @media print { .no-print { display: none !important; } #cupom-print { display: block !important; width: 58mm; font-family: monospace; } }
    </style>
</head>
<body>

    <div class="no-print">
        <div class="nav-buttons">
            <button class="btn">üñ•Ô∏è Gest√£o</button>
            <button class="btn" style="background:#6c757d">üßë‚Äçüíª Admin</button>
        </div>
        <h1>Painel de Pedidos Spook Ice</h1>
        <div id="status">A ligar √† planilha...</div>
    </div>

    <div id="lista-pedidos" class="no-print"></div>
    <div id="cupom-print" style="display: none;"></div>

    <script>
        // LINK CSV ORIGINAL
        const baseLink = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSJs2mCWo_bv2C7OqYYzuhs_rh8CYfusDhR7UiS4Yj9sUw3C6hNcP6fFlXZOpmAlYZId-jAt8xAC5dM/pub?output=csv";
        
        let concluidos = JSON.parse(localStorage.getItem('spook_concluidos')) || [];

        async function carregarDados() {
            const status = document.getElementById('status');
            try {
                // For√ßa o navegador a buscar dados novos (evita cache)
                const response = await fetch(`${baseLink}&cache=${new Date().getTime()}`);
                if (!response.ok) throw new Error("Erro ao acessar link");
                
                const data = await response.text();
                // Converte CSV para Array (limpa aspas e lida com v√≠rgulas)
                const rows = data.split(/\r?\n/).map(row => row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/));

                const container = document.getElementById('lista-pedidos');
                container.innerHTML = "";

                if (rows.length < 2) {
                    status.innerText = "Planilha conectada, mas sem dados nas linhas.";
                    return;
                }

                // Come√ßa da √∫ltima linha para a primeira (pedidos mais recentes no topo)
                for (let i = rows.length - 1; i >= 1; i--) {
                    const col = rows[i];
                    
                    // COLUNA M √© o √≠ndice 12. Vamos verificar se existe.
                    let pedido = col[12] ? col[12].replace(/"/g, '').trim() : "";

                    if (pedido !== "") {
                        let id = btoa(pedido).substring(0, 15) + i;
                        
                        if (!concluidos.includes(id)) {
                            let valor = col[1] ? col[1].replace(/"/g, '') : "0,00";
                            let obs = col[3] ? col[3].replace(/"/g, '') : "";

                            const div = document.createElement('div');
                            div.className = 'card';
                            div.innerHTML = `
                                <button onclick="finalizar('${id}')" style="float:right; background:red; color:white; border:none; border-radius:3px; cursor:pointer;">X</button>
                                <h3>Novo Pedido</h3>
                                <p><strong>Itens:</strong> ${pedido}</p>
                                <p><strong>Total:</strong> R$ ${valor}</p>
                                <button class="btn-imprimir" onclick="imprimir('${pedido}', '${valor}', '${obs}')">üñ®Ô∏è IMPRIMIR</button>
                            `;
                            container.appendChild(div);
                        }
                    }
                }
                status.innerText = "√öltima atualiza√ß√£o: " + new Date().toLocaleTimeString();
                status.style.color = "green";

            } catch (err) {
                status.innerText = "ERRO: O link da planilha pode estar offline ou bloqueado.";
                status.style.color = "red";
            }
        }

        function finalizar(id) {
            concluidos.push(id);
            localStorage.setItem('spook_concluidos', JSON.stringify(concluidos));
            carregarDados();
        }

        function imprimir(p, v, o) {
            const printArea = document.getElementById('cupom-print');
            printArea.innerHTML = `<center><strong>SPOOK ICE</strong><br>------------------<br></center>${p}<br><br><strong>TOTAL: R$ ${v}</strong><br>------------------<br>${o}<br><br><center>Obrigado!</center><br>.`;
            window.print();
        }

        setInterval(carregarDados, 15000); // Atualiza a cada 15 segundos
        carregarDados();
    </script>
</body>
</html>
